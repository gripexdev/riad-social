#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_PRE_PUSH:-}" == "1" || "${SKIP_PRE_PUSH:-}" == "true" ]]; then
  echo "[pre-push] Skipping checks (SKIP_PRE_PUSH set)."
  exit 0
fi

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

changed_files=()
while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ -z "${local_sha}" || -z "${remote_sha}" ]]; then
    continue
  fi
  if [[ "${remote_sha}" == "0000000000000000000000000000000000000000" ]]; then
    range="${local_sha}"
  else
    range="${remote_sha}..${local_sha}"
  fi
  while IFS= read -r file; do
    changed_files+=("$file")
  done < <(git diff --name-only "$range" || true)
done

run_backend=false
run_frontend=false
for file in "${changed_files[@]:-}"; do
  if [[ "$file" == backend/* ]]; then
    run_backend=true
  fi
  if [[ "$file" == frontend/* ]]; then
    run_frontend=true
  fi
done

if ! $run_backend && ! $run_frontend; then
  echo "[pre-push] No backend/frontend changes detected. Skipping."
  exit 0
fi

if $run_backend; then
  echo "[pre-push] Backend tests..."
  (cd backend && ./mvnw -q test)
fi

if $run_frontend; then
  echo "[pre-push] Frontend tests..."
  (cd frontend && npm test -- --watch=false --code-coverage)
fi

echo "[pre-push] Checks passed."
