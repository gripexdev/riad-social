<article class="rounded-3xl border border-line bg-white/90 shadow-soft">
  <header class="relative flex items-center gap-3 px-5 pt-5 pb-3">
    <div class="flex h-11 w-11 items-center justify-center overflow-hidden rounded-full bg-gradient-to-br from-accent to-accent-strong text-sm font-semibold text-white shadow-glow">
      <img *ngIf="post.profilePictureUrl; else postInitial" class="h-full w-full object-cover" [src]="post.profilePictureUrl" [alt]="post.username + ' avatar'">
      <ng-template #postInitial>{{ post.username[0] | uppercase }}</ng-template>
    </div>
    <div class="flex flex-col">
      <a class="text-sm font-semibold text-ink" [routerLink]="['/users', post.username]">{{ post.username }}</a>
      <span class="text-xs uppercase tracking-[0.12em] text-muted">{{ post.createdAt | date:'medium' }}</span>
    </div>
    <div class="ml-auto" *ngIf="hasActions">
      <button class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-transparent text-muted transition hover:border-line hover:text-ink" type="button" (click)="toggleActions()">
        <span class="material-icons text-lg">more_horiz</span>
      </button>
      <div *ngIf="showActions" class="absolute right-5 top-16 z-10 w-40 overflow-hidden rounded-2xl border border-line bg-white shadow-soft">
        <button *ngIf="canEdit" class="flex w-full items-center gap-2 px-4 py-2 text-sm text-ink transition hover:bg-sand" type="button" (click)="startEdit()">
          <span class="material-icons text-base">edit</span>
          Edit caption
        </button>
        <button *ngIf="canDelete" class="flex w-full items-center gap-2 px-4 py-2 text-sm text-rose-600 transition hover:bg-rose-50" type="button" (click)="openDeleteConfirm()">
          <span class="material-icons text-base">delete</span>
          Delete post
        </button>
      </div>
    </div>
  </header>
  <div class="bg-sand">
    <img class="aspect-square w-full object-cover" [src]="post.imageUrl" [alt]="'Photo by ' + post.username" loading="lazy">
  </div>
  <div class="px-5 py-4">
    <div class="flex flex-wrap items-center gap-6 text-sm">
      <button class="flex items-center gap-2 font-semibold text-ink" type="button" (click)="toggleLike()">
        <span class="material-icons text-lg" [class.text-rose-500]="post.likedByCurrentUser" [class.text-muted]="!post.likedByCurrentUser">favorite</span>
        <span>{{ post.likesCount }} likes</span>
      </button>
      <button class="flex items-center gap-2 font-semibold text-ink" type="button" (click)="toggleComments()">
        <span class="material-icons text-lg">chat_bubble</span>
        <span>{{ post.comments.length }} comments</span>
      </button>
    </div>
    <div class="mt-3 text-sm text-ink">
      <ng-container *ngIf="!isEditing || !canEdit; else editCaption">
        <a class="font-semibold" [routerLink]="['/users', post.username]">{{ post.username }}</a>
        {{ post.caption }}
      </ng-container>
      <ng-template #editCaption>
        <form [formGroup]="editForm" (ngSubmit)="saveEdit()" class="space-y-3">
          <textarea class="w-full rounded-2xl border border-line bg-white px-4 py-3 text-sm text-ink placeholder:text-muted focus:border-accent focus:outline-none" formControlName="caption" rows="3" placeholder="Update your caption..."></textarea>
          <div class="flex flex-wrap items-center gap-2">
            <button class="rounded-full bg-gradient-to-r from-accent to-accent-strong px-4 py-2 text-xs font-semibold text-white shadow-glow transition hover:opacity-90 disabled:opacity-60" type="submit" [disabled]="isSaving">
              Save
            </button>
            <button class="rounded-full border border-line px-4 py-2 text-xs font-semibold text-ink transition hover:border-ink/40 disabled:opacity-60" type="button" (click)="cancelEdit()" [disabled]="isSaving">
              Cancel
            </button>
          </div>
        </form>
      </ng-template>
      <div *ngIf="errorMessage" class="mt-2 text-xs text-red-600">
        {{ errorMessage }}
      </div>
    </div>
  </div>
  <section *ngIf="showComments" class="border-t border-line bg-cream/70 px-5 py-4">
    <div class="flex max-h-44 flex-col gap-2 overflow-y-auto">
      <div *ngFor="let comment of post.comments" class="text-sm text-ink">
        <div class="flex flex-wrap items-center gap-2">
          <a class="font-semibold" [routerLink]="['/users', comment.username]">{{ comment.username }}</a>
          <span class="text-muted">{{ comment.content }}</span>
        </div>
        <div class="mt-1 flex items-center gap-3 text-[11px] uppercase tracking-[0.18em] text-muted">
          <button class="transition hover:text-ink" type="button" (click)="startReply(comment)">Reply</button>
          <span *ngIf="comment.replies?.length as replyCount">{{ replyCount }} replies</span>
        </div>

        <div *ngIf="comment.replies?.length" class="mt-2 flex flex-col gap-2 border-l border-line/70 pl-4">
          <div *ngFor="let reply of comment.replies" class="flex flex-wrap items-center gap-2 text-xs text-ink">
            <a class="font-semibold" [routerLink]="['/users', reply.username]">{{ reply.username }}</a>
            <span class="text-muted">{{ reply.content }}</span>
            <button *ngIf="reply.username === currentUsername"
                    class="ml-auto inline-flex h-6 w-6 items-center justify-center rounded-full text-muted transition hover:bg-rose-50 hover:text-rose-600"
                    type="button"
                    aria-label="Delete reply"
                    (click)="deleteReply(comment, reply)">
              <span class="material-icons text-[16px]">delete_outline</span>
            </button>
          </div>
        </div>

        <form *ngIf="activeReplyCommentId === comment.id" [formGroup]="replyForm" (ngSubmit)="addReply(comment)" class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center">
          <input class="w-full flex-1 rounded-2xl border border-line bg-white px-4 py-2 text-xs text-ink placeholder:text-muted focus:border-accent focus:outline-none"
                 formControlName="reply"
                 [placeholder]="replyTargetUsername ? 'Reply to @' + replyTargetUsername + '...' : 'Write a reply...'"
                 required>
          <div class="flex items-center gap-2">
            <button class="rounded-full bg-gradient-to-r from-accent to-accent-strong px-4 py-2 text-xs font-semibold text-white shadow-glow transition hover:opacity-90"
                    type="submit"
                    [disabled]="!replyForm.valid">
              Reply
            </button>
            <button class="rounded-full border border-line px-4 py-2 text-xs font-semibold text-ink transition hover:border-ink/40"
                    type="button"
                    (click)="cancelReply()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
    <form [formGroup]="commentForm" (ngSubmit)="addComment()" class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center">
      <input class="w-full flex-1 rounded-2xl border border-line bg-white px-4 py-2 text-sm text-ink placeholder:text-muted focus:border-accent focus:outline-none" formControlName="comment" placeholder="Add a comment..." required>
      <button class="rounded-full bg-gradient-to-r from-accent to-accent-strong px-5 py-2 text-sm font-semibold text-white shadow-glow transition hover:opacity-90" type="submit" [disabled]="!commentForm.valid">Post</button>
    </form>
  </section>

  <div *ngIf="showDeleteConfirm" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-6 backdrop-blur-sm" role="button" tabindex="0" aria-label="Close delete confirmation" (click)="closeDeleteConfirm()" (keydown.enter)="closeDeleteConfirm()" (keydown.space)="closeDeleteConfirm()">
    <div class="w-full max-w-sm rounded-3xl border border-line bg-white p-6 shadow-soft" role="dialog" aria-modal="true" tabindex="0" (click)="$event.stopPropagation()" (keydown.escape)="closeDeleteConfirm()" (keydown)="$event.stopPropagation()">
      <div class="flex items-start gap-4">
        <div class="flex h-12 w-12 items-center justify-center rounded-2xl bg-rose-50 text-rose-600">
          <span class="material-icons">delete_forever</span>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-ink">Delete this post?</h3>
          <p class="mt-1 text-sm text-muted">This will permanently remove the post, its caption, and comments.</p>
        </div>
      </div>
      <div *ngIf="errorMessage" class="mt-3 text-xs text-rose-600">
        {{ errorMessage }}
      </div>
      <div class="mt-6 flex flex-col gap-2 sm:flex-row sm:justify-end">
        <button class="rounded-full border border-line px-4 py-2 text-sm font-semibold text-ink transition hover:border-ink/40 disabled:opacity-60" type="button" (click)="closeDeleteConfirm()" [disabled]="isSaving">
          Cancel
        </button>
        <button class="rounded-full bg-rose-600 px-4 py-2 text-sm font-semibold text-white shadow-soft transition hover:bg-rose-500 disabled:opacity-60" type="button" (click)="confirmDelete()" [disabled]="isSaving">
          {{ isSaving ? 'Deleting...' : 'Delete post' }}
        </button>
      </div>
    </div>
  </div>
</article>
