<div *ngIf="profile" class="mx-auto w-full max-w-6xl space-y-6">
  <section class="rounded-3xl border border-line bg-white/90 p-6 shadow-soft">
    <div class="flex flex-col gap-6 md:flex-row md:items-center">
      <div class="flex h-28 w-28 items-center justify-center overflow-hidden rounded-full bg-gradient-to-br from-accent to-accent-strong text-2xl font-semibold text-white ring-4 ring-cream">
        <img *ngIf="displayAvatarUrl; else profileInitialTpl" class="h-full w-full object-cover" [src]="displayAvatarUrl" [alt]="profile.username + ' avatar'">
        <ng-template #profileInitialTpl>{{ profileInitial }}</ng-template>
      </div>
      <div class="flex-1 space-y-3">
        <div class="flex flex-wrap items-center gap-4">
          <h2 class="text-2xl font-semibold text-ink">{{ profile.username }}</h2>
          <button class="rounded-full border border-line px-4 py-2 text-sm font-semibold text-ink transition hover:border-ink/40" *ngIf="!isOwnProfile && authService.isAuthenticated()" type="button" (click)="onFollowToggle()">
            {{ profile.isFollowing ? 'Unfollow' : 'Follow' }}
          </button>
          <button class="rounded-full border border-line px-4 py-2 text-sm font-semibold text-ink transition hover:border-ink/40" *ngIf="!isOwnProfile && authService.isAuthenticated()" type="button" (click)="startMessage()">
            Message
          </button>
          <button class="rounded-full border border-line px-4 py-2 text-sm font-semibold text-ink transition hover:border-ink/40" *ngIf="isOwnProfile && !isEditing" type="button" (click)="startEdit()">
            Edit profile
          </button>
        </div>
        <div class="text-sm text-muted">{{ profile.fullName }}</div>
        <p class="text-sm text-ink">{{ profile.bio }}</p>
        <div class="flex flex-wrap gap-6 text-sm text-muted">
          <span><span class="font-semibold text-ink">{{ profile.postCount }}</span> posts</span>
          <span><span class="font-semibold text-ink">{{ profile.followerCount }}</span> followers</span>
          <span><span class="font-semibold text-ink">{{ profile.followingCount }}</span> following</span>
        </div>
      </div>
    </div>
  </section>

  <section *ngIf="isOwnProfile && isEditing" class="rounded-3xl border border-line bg-white/90 p-6 shadow-soft">
    <div class="flex flex-col gap-6 lg:flex-row">
      <div class="lg:w-1/2">
        <div class="text-xs uppercase tracking-[0.2em] text-muted">Preview</div>
        <div class="mt-3 overflow-hidden rounded-2xl border border-line bg-sand">
          <div class="flex aspect-square items-center justify-center bg-gradient-to-br from-accent/10 to-accent-strong/20 text-3xl font-semibold text-accent">
            <img *ngIf="displayAvatarUrl; else previewInitial" class="h-full w-full object-cover" [src]="displayAvatarUrl" alt="Profile preview">
            <ng-template #previewInitial>{{ profileInitial }}</ng-template>
          </div>
        </div>
        <div class="mt-4 rounded-2xl bg-cream/70 px-4 py-3 text-sm text-ink">
          <div class="flex items-center justify-between text-xs uppercase tracking-[0.2em] text-muted">
            <span>Bio</span>
            <span *ngIf="selectedAvatar">{{ formatFileSize(selectedAvatar.size) }}</span>
          </div>
          <p class="mt-2 whitespace-pre-line text-sm">
            {{ profileForm.value.bio || 'Add a short bio to introduce yourself.' }}
          </p>
        </div>
      </div>

      <div class="lg:w-1/2">
        <div class="text-xs uppercase tracking-[0.2em] text-muted">Edit details</div>
        <form class="mt-4 space-y-4" [formGroup]="profileForm" (ngSubmit)="saveProfile()">
          <label class="flex cursor-pointer flex-col items-center gap-2 rounded-2xl border border-dashed border-line bg-cream/70 p-5 text-center transition hover:border-accent">
            <input #avatarInput class="hidden" type="file" accept="image/*" (change)="onAvatarSelected($event)">
            <span class="material-icons text-4xl text-accent">portrait</span>
            <span class="text-sm font-semibold text-ink">Change avatar</span>
            <span class="text-xs text-muted">PNG or JPG up to 10MB.</span>
          </label>
          <textarea class="w-full rounded-2xl border border-line bg-white px-4 py-3 text-sm text-ink placeholder:text-muted focus:border-accent focus:outline-none" formControlName="bio" rows="5" placeholder="Write a short bio..."></textarea>
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
            <button class="flex-1 rounded-full bg-gradient-to-r from-accent to-accent-strong px-5 py-3 text-sm font-semibold text-white shadow-glow transition hover:opacity-90 disabled:opacity-60" type="submit" [disabled]="isSaving">
              {{ isSaving ? 'Saving...' : 'Save changes' }}
            </button>
            <button class="flex-1 rounded-full border border-line px-5 py-3 text-sm font-semibold text-ink transition hover:border-ink/40" type="button" (click)="cancelEdit()" [disabled]="isSaving">
              Cancel
            </button>
          </div>
        </form>
        <div *ngIf="errorMessage" class="mt-3 text-sm text-red-600">
          {{ errorMessage }}
        </div>
      </div>
    </div>
  </section>

  <section>
    <div class="mb-4 flex items-center justify-between">
      <h3 class="text-lg font-semibold text-ink">Posts</h3>
    </div>
    <div class="grid gap-6 md:grid-cols-2">
      <div *ngFor="let post of profile.posts" class="fade-up">
        <app-post-card [post]="post" [canEdit]="isOwnProfile" [canDelete]="isOwnProfile" (postDeleted)="removePost($event)"></app-post-card>
      </div>
    </div>
  </section>
</div>
