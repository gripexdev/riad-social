<ng-container *ngIf="authService.isAuthenticated(); else publicShell">
  <div class="min-h-screen">
    <aside class="hidden lg:fixed lg:inset-y-0 lg:flex lg:w-64 lg:flex-col lg:border-r lg:border-white/10 lg:bg-gradient-to-b lg:from-[#0f1114] lg:via-[#111418] lg:to-[#0b0d10]">
      <div class="flex h-full flex-col px-5 pb-6 pt-7 text-white">
        <a class="brand text-2xl text-white" routerLink="/home">Riad</a>
        <nav class="mt-10 flex-1 space-y-1 text-sm" aria-label="Primary">
          <a class="group flex items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/70 transition hover:bg-white/10 hover:text-white" routerLink="/home" routerLinkActive="bg-white/10 text-white" [routerLinkActiveOptions]="{ exact: true }">
            <span class="material-icons text-[22px]">home</span>
            <span>Home</span>
          </a>
          <a class="group flex items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/70 transition hover:bg-white/10 hover:text-white" routerLink="/search" routerLinkActive="bg-white/10 text-white">
            <span class="material-icons text-[22px]">search</span>
            <span>Search</span>
          </a>
          <a class="group flex items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/70 transition hover:bg-white/10 hover:text-white" routerLink="/explore" routerLinkActive="bg-white/10 text-white">
            <span class="material-icons text-[22px]">explore</span>
            <span>Explore</span>
          </a>
          <button class="flex cursor-not-allowed items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/40" type="button" disabled>
            <span class="material-icons text-[22px]">smart_display</span>
            <span>Reels</span>
          </button>
          <button class="flex cursor-not-allowed items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/40" type="button" disabled>
            <span class="material-icons text-[22px]">chat_bubble_outline</span>
            <span>Messages</span>
          </button>
          <button class="group flex items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/70 transition hover:bg-white/10 hover:text-white" type="button" [ngClass]="{ 'bg-white/10 text-white': notificationsOpen }" (click)="toggleNotifications()" aria-label="Notifications" [attr.aria-pressed]="notificationsOpen">
            <span class="relative flex items-center">
              <span class="material-icons text-[22px]">favorite_border</span>
              <span *ngIf="unreadCount > 0" class="absolute -right-2 -top-1 flex h-4 min-w-[16px] items-center justify-center rounded-full bg-rose-500 px-1 text-[10px] font-semibold text-white">
                {{ getUnreadBadge() }}
              </span>
            </span>
            <span>Notifications</span>
            <span *ngIf="unreadCount > 0" class="ml-auto rounded-full bg-rose-500/20 px-2 py-0.5 text-[11px] font-semibold text-rose-100">
              {{ getUnreadBadge() }}
            </span>
          </button>
          <a class="group flex items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/70 transition hover:bg-white/10 hover:text-white" routerLink="/create-post" routerLinkActive="bg-white/10 text-white">
            <span class="material-icons text-[22px]">add_box</span>
            <span>Create</span>
          </a>
          <ng-container *ngIf="authService.getUsername() as username; else profilePlaceholder">
            <a class="group flex items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/70 transition hover:bg-white/10 hover:text-white" [routerLink]="['/users', username]" routerLinkActive="bg-white/10 text-white">
              <span class="material-icons text-[22px]">person</span>
              <span>Profile</span>
            </a>
          </ng-container>
          <ng-template #profilePlaceholder>
            <button class="flex cursor-not-allowed items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/40" type="button" disabled>
              <span class="material-icons text-[22px]">person</span>
              <span>Profile</span>
            </button>
          </ng-template>
        </nav>
        <div class="mt-6 space-y-1 border-t border-white/10 pt-4">
          <button class="group flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/70 transition hover:bg-white/10 hover:text-white" type="button">
            <span class="material-icons text-[22px]">menu</span>
            <span>More</span>
          </button>
          <button class="group flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-sm font-semibold text-white/70 transition hover:bg-white/10 hover:text-white" type="button" (click)="logout()">
            <span class="material-icons text-[22px]">logout</span>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </aside>

    <div class="lg:pl-64">
      <header class="sticky top-0 z-40 border-b border-line bg-white/80 backdrop-blur lg:hidden">
        <div class="mx-auto flex w-full max-w-6xl items-center justify-between px-4 py-3">
          <a class="brand text-2xl text-ink" routerLink="/home">Riad</a>
          <nav class="flex items-center gap-2 text-muted" aria-label="Primary">
            <a class="rounded-full p-2 transition hover:bg-sand hover:text-ink" routerLink="/home">
              <span class="material-icons text-[20px]">home</span>
            </a>
            <a class="rounded-full p-2 transition hover:bg-sand hover:text-ink" routerLink="/search">
              <span class="material-icons text-[20px]">search</span>
            </a>
            <a class="rounded-full p-2 transition hover:bg-sand hover:text-ink" routerLink="/explore">
              <span class="material-icons text-[20px]">explore</span>
            </a>
            <a class="rounded-full p-2 transition hover:bg-sand hover:text-ink" routerLink="/create-post">
              <span class="material-icons text-[20px]">add_box</span>
            </a>
            <button class="relative rounded-full p-2 transition hover:bg-sand hover:text-ink" type="button" (click)="toggleNotifications()" aria-label="Notifications" [attr.aria-pressed]="notificationsOpen">
              <span class="material-icons text-[20px]">favorite_border</span>
              <span *ngIf="unreadCount > 0" class="absolute -right-1 -top-1 flex h-4 min-w-[16px] items-center justify-center rounded-full bg-rose-500 px-1 text-[10px] font-semibold text-white">
                {{ getUnreadBadge() }}
              </span>
            </button>
            <button class="rounded-full p-2 transition hover:bg-sand hover:text-ink" type="button" (click)="logout()">
              <span class="material-icons text-[20px]">logout</span>
            </button>
          </nav>
        </div>
      </header>

      <main class="px-4 pb-16 pt-6">
        <router-outlet></router-outlet>
      </main>
    </div>

    <ng-container *ngIf="notificationsOpen">
      <div class="fixed inset-y-0 left-0 right-0 z-40 bg-black/50 lg:left-64" (click)="closeNotifications()"></div>
      <section class="notifications-drawer fixed inset-y-0 left-0 z-50 w-full max-w-none bg-[#0f1114] text-white shadow-2xl lg:left-64 lg:max-w-sm" (click)="$event.stopPropagation()">
        <div class="flex h-full flex-col">
          <div class="flex items-center justify-between border-b border-white/10 px-5 py-4">
            <h2 class="text-lg font-semibold text-white">Notifications</h2>
            <button class="rounded-full p-2 text-white/60 transition hover:bg-white/10 hover:text-white" type="button" (click)="closeNotifications()" aria-label="Close notifications">
              <span class="material-icons text-[20px]">close</span>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto px-4 py-5">
            <div *ngIf="notificationsLoading" class="space-y-3">
              <div class="h-12 rounded-2xl bg-white/5"></div>
              <div class="h-12 rounded-2xl bg-white/5"></div>
              <div class="h-12 rounded-2xl bg-white/5"></div>
            </div>
            <div *ngIf="notificationsError" class="rounded-2xl border border-rose-500/40 bg-rose-500/10 px-4 py-3 text-sm text-rose-100">
              {{ notificationsError }}
            </div>
            <div *ngIf="!notificationsLoading && !notificationsError && notifications.length === 0" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-6 text-center text-sm text-white/60">
              No notifications yet.
            </div>

            <div *ngIf="recentNotifications.length > 0" class="mt-6 space-y-3">
              <div class="text-xs uppercase tracking-[0.2em] text-white/50">This week</div>
              <div class="space-y-2">
                <div *ngFor="let notification of recentNotifications" class="flex items-center gap-3 rounded-2xl px-3 py-2 transition hover:bg-white/5" [ngClass]="{ 'bg-white/5': !notification.isRead }">
                  <div class="flex h-11 w-11 items-center justify-center overflow-hidden rounded-full bg-white/10 text-sm font-semibold text-white">
                    <img *ngIf="notification.actorProfilePictureUrl; else recentInitial" class="h-full w-full object-cover" [src]="notification.actorProfilePictureUrl" [alt]="notification.actorUsername + ' avatar'">
                    <ng-template #recentInitial>{{ notification.actorUsername[0] | uppercase }}</ng-template>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm leading-snug text-white/80">
                      <a class="font-semibold text-white" [routerLink]="['/users', notification.actorUsername]" (click)="closeNotifications()">{{ notification.actorUsername }}</a>
                      <span class="ml-1">{{ getNotificationMessage(notification) }}</span>
                      <span class="ml-2 text-xs text-white/40">{{ getRelativeTime(notification.createdAt) }}</span>
                    </div>
                    <div *ngIf="notification.commentPreview" class="mt-1 text-xs text-white/50">"{{ notification.commentPreview }}"</div>
                  </div>
                  <ng-container *ngIf="notification.type === 'FOLLOW'; else recentPostPreview">
                    <button class="rounded-full border border-white/20 px-3 py-1 text-xs font-semibold text-white/80 transition hover:border-white/60 hover:text-white disabled:opacity-60" type="button" [disabled]="isFollowLoading(notification.actorUsername)" (click)="toggleFollow(notification)">
                      {{ notification.actorFollowed ? 'Following' : 'Follow' }}
                    </button>
                  </ng-container>
                  <ng-template #recentPostPreview>
                    <img *ngIf="notification.postImageUrl" class="h-12 w-12 rounded-xl object-cover" [src]="notification.postImageUrl" [alt]="'Post by ' + notification.actorUsername">
                  </ng-template>
                </div>
              </div>
            </div>

            <div *ngIf="earlierNotifications.length > 0" class="mt-6 space-y-3">
              <div class="text-xs uppercase tracking-[0.2em] text-white/50">Earlier</div>
              <div class="space-y-2">
                <div *ngFor="let notification of earlierNotifications" class="flex items-center gap-3 rounded-2xl px-3 py-2 transition hover:bg-white/5" [ngClass]="{ 'bg-white/5': !notification.isRead }">
                  <div class="flex h-11 w-11 items-center justify-center overflow-hidden rounded-full bg-white/10 text-sm font-semibold text-white">
                    <img *ngIf="notification.actorProfilePictureUrl; else earlierInitial" class="h-full w-full object-cover" [src]="notification.actorProfilePictureUrl" [alt]="notification.actorUsername + ' avatar'">
                    <ng-template #earlierInitial>{{ notification.actorUsername[0] | uppercase }}</ng-template>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm leading-snug text-white/80">
                      <a class="font-semibold text-white" [routerLink]="['/users', notification.actorUsername]" (click)="closeNotifications()">{{ notification.actorUsername }}</a>
                      <span class="ml-1">{{ getNotificationMessage(notification) }}</span>
                      <span class="ml-2 text-xs text-white/40">{{ getRelativeTime(notification.createdAt) }}</span>
                    </div>
                    <div *ngIf="notification.commentPreview" class="mt-1 text-xs text-white/50">"{{ notification.commentPreview }}"</div>
                  </div>
                  <ng-container *ngIf="notification.type === 'FOLLOW'; else earlierPostPreview">
                    <button class="rounded-full border border-white/20 px-3 py-1 text-xs font-semibold text-white/80 transition hover:border-white/60 hover:text-white disabled:opacity-60" type="button" [disabled]="isFollowLoading(notification.actorUsername)" (click)="toggleFollow(notification)">
                      {{ notification.actorFollowed ? 'Following' : 'Follow' }}
                    </button>
                  </ng-container>
                  <ng-template #earlierPostPreview>
                    <img *ngIf="notification.postImageUrl" class="h-12 w-12 rounded-xl object-cover" [src]="notification.postImageUrl" [alt]="'Post by ' + notification.actorUsername">
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </ng-container>
  </div>
</ng-container>

<ng-template #publicShell>
  <header class="sticky top-0 z-40 border-b border-line bg-white/80 backdrop-blur">
    <div class="mx-auto flex w-full max-w-6xl items-center justify-between px-4 py-3">
      <a class="brand text-3xl text-ink" routerLink="/login">Riad</a>
      <nav class="flex flex-wrap items-center gap-2 text-xs font-semibold sm:text-sm">
        <a class="rounded-full px-4 py-2 text-muted transition hover:bg-sand hover:text-ink" routerLink="/login">Login</a>
        <a class="rounded-full px-4 py-2 text-muted transition hover:bg-sand hover:text-ink" routerLink="/register">Register</a>
      </nav>
    </div>
  </header>

  <main class="px-4 pb-16 pt-6">
    <router-outlet></router-outlet>
  </main>
</ng-template>
