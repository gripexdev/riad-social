<div class="messages-shell">
  <div class="messages-frame">
    <aside class="messages-sidebar">
      <div class="messages-sidebar__top">
        <div class="sidebar-account">
          <div class="sidebar-account__name">
            <span class="sidebar-account__label">{{ currentUsername || 'Messages' }}</span>
            <span class="material-icons">keyboard_arrow_down</span>
          </div>
          <button class="icon-button" type="button" (click)="startNewMessage()">
            <span class="material-icons">edit</span>
          </button>
        </div>

        <label class="messages-search">
          <span class="material-icons">search</span>
          <input type="text" placeholder="Search" aria-label="Search conversations" />
        </label>

        <div class="notes-strip">
          <div class="notes-title">Notes</div>
          <div class="notes-row">
            <div class="note-card">
              <div class="note-avatar note-avatar--me">
                <span>{{ currentUsername ? (currentUsername[0] | uppercase) : 'U' }}</span>
              </div>
              <div class="note-label">Your note</div>
            </div>
            <ng-container *ngFor="let conversation of conversations | slice:0:6">
              <div class="note-card">
                <div class="note-avatar">
                  <img *ngIf="conversation.participantProfilePictureUrl; else noteInitial" class="note-image" [src]="conversation.participantProfilePictureUrl" [alt]="conversation.participantUsername + ' avatar'">
                  <ng-template #noteInitial>{{ conversation.participantUsername[0] | uppercase }}</ng-template>
                </div>
                <div class="note-label">{{ conversation.participantUsername }}</div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>

      <div class="messages-sidebar__list">
        <div class="messages-list-header">
          <h3>Messages</h3>
          <button type="button" class="messages-list-action">Requests</button>
        </div>

        <div class="conversation-list">
          <div *ngIf="isLoadingConversations" class="list-state">
            Loading conversations...
          </div>
          <div *ngIf="errorMessage" class="list-state list-state--error">
            {{ errorMessage }}
          </div>
          <div *ngIf="!isLoadingConversations && !errorMessage && conversations.length === 0" class="list-state">
            No conversations yet. Start a new message.
          </div>

          <button
            *ngFor="let conversation of conversations; trackBy: trackByConversationId"
            type="button"
            class="conversation-item"
            [class.is-active]="selectedConversationId === conversation.id"
            (click)="selectConversation(conversation)"
            [attr.aria-pressed]="selectedConversationId === conversation.id"
          >
            <div class="conversation-avatar">
              <img *ngIf="conversation.participantProfilePictureUrl; else participantInitial" class="conversation-image" [src]="conversation.participantProfilePictureUrl" [alt]="conversation.participantUsername + ' avatar'">
              <ng-template #participantInitial>{{ conversation.participantUsername[0] | uppercase }}</ng-template>
            </div>
            <div class="conversation-content">
              <div class="conversation-title">
                <span class="conversation-name">{{ conversation.participantUsername }}</span>
              </div>
              <div class="conversation-preview">
                <span class="conversation-preview__text">{{ getConversationPreview(conversation) }}</span>
                <span *ngIf="conversation.lastMessageAt" class="conversation-preview__dot">&middot;</span>
                <span *ngIf="conversation.lastMessageAt" class="conversation-preview__time">{{ formatRelativeTime(conversation.lastMessageAt) }}</span>
              </div>
            </div>
            <span *ngIf="conversation.unreadCount > 0" class="conversation-unread"></span>
          </button>
        </div>
      </div>
    </aside>

    <section class="messages-thread">
      <ng-container *ngIf="selectedConversation; else emptyHeader">
        <header class="thread-header">
          <div class="thread-user">
            <div class="thread-avatar">
              <img *ngIf="selectedConversation.participantProfilePictureUrl; else selectedInitial" class="thread-image" [src]="selectedConversation.participantProfilePictureUrl" [alt]="selectedConversation.participantUsername + ' avatar'">
              <ng-template #selectedInitial>{{ selectedConversation.participantUsername[0] | uppercase }}</ng-template>
            </div>
            <div>
              <div class="thread-name">{{ selectedConversation.participantUsername }}</div>
              <div class="thread-subtitle">{{ selectedConversation.participantFullName || ' ' }}</div>
            </div>
          </div>
          <a class="thread-action" [routerLink]="['/users', selectedConversation.participantUsername]">
            <span class="material-icons">info</span>
          </a>
        </header>
      </ng-container>
      <ng-template #emptyHeader>
        <header class="thread-header thread-header--empty"></header>
      </ng-template>

      <div class="thread-body message-scroll" #messageScroll>
        <ng-container *ngIf="selectedConversationId; else emptyState">
          <div *ngIf="isLoadingMessages" class="thread-state">
            Loading messages...
          </div>
          <div *ngIf="messageLoadError" class="thread-state thread-state--error">
            {{ messageLoadError }}
          </div>
          <div *ngIf="!isLoadingMessages && !messageLoadError && messages.length === 0" class="thread-state">
            No messages yet. Say hello.
          </div>

          <div *ngFor="let message of messages; trackBy: trackByMessageId" class="message-row" [class.is-outgoing]="isOutgoing(message)">
            <div class="message-bubble">
              <div class="message-content">{{ message.content }}</div>
              <div class="message-time">{{ formatMessageTime(message.createdAt) }}</div>
            </div>
          </div>
          <div *ngIf="showTypingIndicator" class="message-row">
            <div class="message-bubble message-bubble--typing" aria-label="Typing">
              <span class="typing-dot"></span>
              <span class="typing-dot"></span>
              <span class="typing-dot"></span>
            </div>
          </div>
        </ng-container>

        <ng-template #emptyState>
          <div class="thread-empty">
            <div class="thread-empty__icon">
              <span class="material-icons">send</span>
            </div>
            <h3>Your messages</h3>
            <p>Send private photos and messages to a friend or group.</p>
            <button class="thread-empty__button" type="button" (click)="startNewMessage()">Send message</button>
          </div>
        </ng-template>
      </div>

      <div class="thread-composer" *ngIf="selectedConversationId || isComposingNew">
        <div *ngIf="!selectedConversationId" class="composer-recipient">
          <label>To</label>
          <input
            type="text"
            [formControl]="recipientControl"
            placeholder="username"
            aria-label="Recipient username"
          />
        </div>
        <div class="composer-field">
          <label>Message</label>
          <textarea
            rows="2"
            [formControl]="messageControl"
            (keydown)="onMessageKeydown($event)"
            (input)="onMessageInput()"
            (blur)="onMessageBlur()"
            placeholder="Write a message..."
          ></textarea>
        </div>
        <div class="composer-actions">
          <span class="composer-count">{{ messageLength }} / {{ maxMessageLength }}</span>
          <button
            class="composer-send"
            type="button"
            [disabled]="!canSend()"
            (click)="sendMessage()"
          >
            {{ isSending ? 'Sending...' : 'Send' }}
          </button>
        </div>
        <div *ngIf="sendError" class="composer-error">
          {{ sendError }}
        </div>
      </div>
    </section>
  </div>
</div>
